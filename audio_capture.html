<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture Audio avec WebRTC</title>
</head>
<body>

    <h1>Application de Capture Audio</h1>
    <button id="startButton">Démarrer la capture et la transmission audio</button>
    <p id="status">Statut : En attente de capture...</p>

    <script>
        let peerConnection;
        const signalingServerURL = "wss://ohmamie.glitch.me"; // URL de Glitch
        const socket = new WebSocket(signalingServerURL);

        socket.onopen = () => {
            console.log("Connecté au serveur de signalement");
        };

socket.onmessage = async (message) => {
    // Vérifie si le message est un objet Blob
    if (message.data instanceof Blob) {
        console.log("Message reçu en Blob :", message.data);

        // Convertir le Blob en texte
        message.data = await message.data.text();
    }

    console.log("Message brut reçu :", message.data);

    try {
        const data = JSON.parse(message.data);

        if (data.type === "offer") {
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            createAnswer();
        } else if (data.type === "candidate") {
            peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    } catch (error) {
        console.error("Erreur de parsing JSON :", error);
        console.log("Message reçu non JSON ou mal formé :", message.data);
    }
};



        async function startAudioCapture() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                document.getElementById("status").textContent = "Statut : Audio capturé et en cours de transmission.";
                initializeWebRTC(stream);
            } catch (err) {
                console.error("Erreur lors de la capture audio :", err);
                document.getElementById("status").textContent = "Erreur : Impossible de capturer l'audio.";
            }
        }

        function initializeWebRTC(stream) {
            peerConnection = new RTCPeerConnection();

            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
                }
            };

            peerConnection.createOffer().then((offer) => {
                peerConnection.setLocalDescription(offer);
                socket.send(JSON.stringify({ type: "offer", offer: offer }));
            });
        }

        function createAnswer() {
            peerConnection.createAnswer().then((answer) => {
                peerConnection.setLocalDescription(answer);
                socket.send(JSON.stringify({ type: "answer", answer: answer }));
            });
        }

        document.getElementById("startButton").addEventListener("click", startAudioCapture);
    </script>

</body>
</html>

